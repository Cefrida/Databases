{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "1334d1a2-de5c-421a-90f3-2c9c77e8da20",
   "metadata": {},
   "source": [
    "### Final Project. Due Friday, Dec 15 by midnight.\n",
    "\n",
    "---\n",
    "\n",
    "Several of the questions build on each other. It might be beneficial to write some views for those so you don't end up duplicating the same CTEs/subqueries.\n",
    "\n",
    "Thanks for a great semester!\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "368f339a-9d5f-40c3-b648-db17ae528621",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "d1836d88-d6b6-485a-9414-f1fbc35508f2",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import store \n",
    "import pandas as pd\n",
    "# To force python to reload the module if already loaded\n",
    "from importlib import reload\n",
    "reload(store);\n",
    "import sqlite3\n",
    "# You'll find this library on blackboard\n",
    "import dbga\n",
    "# python libaries specific to making your submission file\n",
    "from collections import defaultdict as dd\n",
    "import json"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "70040497-5197-496d-87fc-8a6e17edd2c4",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'1.0.4'"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "dbga.__version__"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "6d8b8a71-3459-4aec-8465-99ed11a55205",
   "metadata": {},
   "outputs": [],
   "source": [
    "conn = sqlite3.connect('/home/jovyan/Databases/04_Building/store.db')\n",
    "curs = conn.cursor()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "d83e8eac-3406-44f2-9468-9ce7658ad0be",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>type</th>\n",
       "      <th>name</th>\n",
       "      <th>tbl_name</th>\n",
       "      <th>rootpage</th>\n",
       "      <th>sql</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>table</td>\n",
       "      <td>sqlite_sequence</td>\n",
       "      <td>sqlite_sequence</td>\n",
       "      <td>3</td>\n",
       "      <td>CREATE TABLE sqlite_sequence(name,seq)</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>table</td>\n",
       "      <td>tState</td>\n",
       "      <td>tState</td>\n",
       "      <td>2</td>\n",
       "      <td>CREATE TABLE tState (\\n                    sta...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>index</td>\n",
       "      <td>sqlite_autoindex_tState_1</td>\n",
       "      <td>tState</td>\n",
       "      <td>4</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>table</td>\n",
       "      <td>tZip</td>\n",
       "      <td>tZip</td>\n",
       "      <td>5</td>\n",
       "      <td>CREATE TABLE tZip (\\n                    zip T...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>index</td>\n",
       "      <td>sqlite_autoindex_tZip_1</td>\n",
       "      <td>tZip</td>\n",
       "      <td>6</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>table</td>\n",
       "      <td>tCust</td>\n",
       "      <td>tCust</td>\n",
       "      <td>7</td>\n",
       "      <td>CREATE TABLE tCust (\\n                    cust...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>table</td>\n",
       "      <td>tOrder</td>\n",
       "      <td>tOrder</td>\n",
       "      <td>8</td>\n",
       "      <td>CREATE TABLE tOrder (\\n                    ord...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>table</td>\n",
       "      <td>tProd</td>\n",
       "      <td>tProd</td>\n",
       "      <td>9</td>\n",
       "      <td>CREATE TABLE tProd (\\n                    prod...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>table</td>\n",
       "      <td>tOrderDetail</td>\n",
       "      <td>tOrderDetail</td>\n",
       "      <td>10</td>\n",
       "      <td>CREATE TABLE tOrderDetail (\\n                 ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>index</td>\n",
       "      <td>sqlite_autoindex_tOrderDetail_1</td>\n",
       "      <td>tOrderDetail</td>\n",
       "      <td>11</td>\n",
       "      <td>None</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>view</td>\n",
       "      <td>StateSalesView</td>\n",
       "      <td>StateSalesView</td>\n",
       "      <td>0</td>\n",
       "      <td>CREATE VIEW StateSalesView AS\\nWITH StateSales...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>view</td>\n",
       "      <td>vOrder_DatesParsed</td>\n",
       "      <td>vOrder_DatesParsed</td>\n",
       "      <td>0</td>\n",
       "      <td>CREATE VIEW vOrder_DatesParsed as\\nSELECT *, S...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     type                             name            tbl_name  rootpage  \\\n",
       "0   table                  sqlite_sequence     sqlite_sequence         3   \n",
       "1   table                           tState              tState         2   \n",
       "2   index        sqlite_autoindex_tState_1              tState         4   \n",
       "3   table                             tZip                tZip         5   \n",
       "4   index          sqlite_autoindex_tZip_1                tZip         6   \n",
       "5   table                            tCust               tCust         7   \n",
       "6   table                           tOrder              tOrder         8   \n",
       "7   table                            tProd               tProd         9   \n",
       "8   table                     tOrderDetail        tOrderDetail        10   \n",
       "9   index  sqlite_autoindex_tOrderDetail_1        tOrderDetail        11   \n",
       "10   view                   StateSalesView      StateSalesView         0   \n",
       "11   view               vOrder_DatesParsed  vOrder_DatesParsed         0   \n",
       "\n",
       "                                                  sql  \n",
       "0              CREATE TABLE sqlite_sequence(name,seq)  \n",
       "1   CREATE TABLE tState (\\n                    sta...  \n",
       "2                                                None  \n",
       "3   CREATE TABLE tZip (\\n                    zip T...  \n",
       "4                                                None  \n",
       "5   CREATE TABLE tCust (\\n                    cust...  \n",
       "6   CREATE TABLE tOrder (\\n                    ord...  \n",
       "7   CREATE TABLE tProd (\\n                    prod...  \n",
       "8   CREATE TABLE tOrderDetail (\\n                 ...  \n",
       "9                                                None  \n",
       "10  CREATE VIEW StateSalesView AS\\nWITH StateSales...  \n",
       "11  CREATE VIEW vOrder_DatesParsed as\\nSELECT *, S...  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "db = store.StoreDB('/home/jovyan/Databases/04_Building/store.db')\n",
    "db.connect()\n",
    "db.conn.execute(\"PRAGMA foreign_keys = ON;\")\n",
    "db.run_query(\"SELECT * FROM sqlite_master;\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "de2882c4-8abf-4576-8371-a92acb0be426",
   "metadata": {},
   "outputs": [],
   "source": [
    "db.drop_all_tables(are_you_sure=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "1562d56d-2b3d-4119-8767-b51ceffcdb9e",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Table tState built successfully.\n",
      "Table tZip built successfully.\n",
      "Table tCust built successfully.\n",
      "Table tOrder built successfully.\n",
      "Table tProd built successfully.\n",
      "Table tOrderDetail built successfully.\n"
     ]
    }
   ],
   "source": [
    "db.build_tables()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "fd56f8b3-a295-4eb8-a7ad-0f9f900b42c9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loading lookup tables...\n",
      "State data loaded:         state state_id\n",
      "0     Alabama       AL\n",
      "1      Alaska       AK\n",
      "2     Arizona       AZ\n",
      "3    Arkansas       AR\n",
      "4  California       CA\n",
      "Data loaded into table.\n",
      "State data loaded into tState table.\n",
      "Product data loaded:    prod_id prod_name  unit_price\n",
      "0      300    Washer        0.10\n",
      "1      301      Nail        0.25\n",
      "2      302       Nut        0.25\n",
      "3      303     Screw        0.50\n",
      "4      304      Bolt        1.00\n",
      "Data loaded into table.\n",
      "Product data loaded into tProd table.\n",
      "Zip data loaded:    zip       city state_id\n",
      "0  601   Adjuntas       PR\n",
      "1  602     Aguada       PR\n",
      "2  603  Aguadilla       PR\n",
      "3  606    Maricao       PR\n",
      "4  610     Anasco       PR\n",
      "Data loaded into table.\n",
      "Zip data loaded into tZip table.\n",
      "Lookup tables loaded.\n"
     ]
    }
   ],
   "source": [
    "db.load_lookup_tables()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "799cd72a-e79f-46c6-9d0b-3287119f0155",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "File Sales_201901.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201902.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201903.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201904.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201905.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201906.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201907.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201908.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201909.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201910.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201911.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_201912.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202001.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202002.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202003.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202004.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202005.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202006.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202007.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202008.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202009.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202010.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202011.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202012.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202101.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202102.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202103.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202104.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202105.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202106.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202107.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202108.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202109.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "File Sales_202110.csv processed and moved to /home/jovyan/Databases/processed_data\n",
      "Data loaded into table.\n"
     ]
    }
   ],
   "source": [
    "db.load_new_data('/home/jovyan/Databases/sales_folder', '/home/jovyan/Databases/processed_data')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "ecad2623-3835-45cf-be84-777e46b15709",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql = dd(dict)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "eab6a350-608f-4ce9-9365-74634f2ee521",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['setup'] = []"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "4fa81d8b-2f08-40f1-adae-3cd9764782ba",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>order_id</th>\n",
       "      <th>cust_id</th>\n",
       "      <th>date</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>2019-01-01</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>2</td>\n",
       "      <td>2019-01-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "      <td>3</td>\n",
       "      <td>2019-01-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>4</td>\n",
       "      <td>2019-01-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>5</td>\n",
       "      <td>5</td>\n",
       "      <td>2019-01-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2922</th>\n",
       "      <td>2923</td>\n",
       "      <td>75</td>\n",
       "      <td>2021-10-29</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2923</th>\n",
       "      <td>2924</td>\n",
       "      <td>23</td>\n",
       "      <td>2021-10-29</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2924</th>\n",
       "      <td>2925</td>\n",
       "      <td>222</td>\n",
       "      <td>2021-10-30</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2925</th>\n",
       "      <td>2926</td>\n",
       "      <td>18</td>\n",
       "      <td>2021-10-31</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2926</th>\n",
       "      <td>2927</td>\n",
       "      <td>21</td>\n",
       "      <td>2021-10-31</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>2927 rows Ã— 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      order_id  cust_id        date\n",
       "0            1        1  2019-01-01\n",
       "1            2        2  2019-01-02\n",
       "2            3        3  2019-01-02\n",
       "3            4        4  2019-01-02\n",
       "4            5        5  2019-01-02\n",
       "...        ...      ...         ...\n",
       "2922      2923       75  2021-10-29\n",
       "2923      2924       23  2021-10-29\n",
       "2924      2925      222  2021-10-30\n",
       "2925      2926       18  2021-10-31\n",
       "2926      2927       21  2021-10-31\n",
       "\n",
       "[2927 rows x 3 columns]"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql(\"SELECT * FROM tOrder;\", conn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f1f84f2b-5fe6-47ba-960f-2782d5152b34",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "16b69d4d-ebbf-4b9d-937e-7372d5137ad8",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<sqlite3.Cursor at 0x7fccabbe1a40>"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "my_sql['setup'] = []\n",
    "\n",
    "# I do need a view for one of the questions\n",
    "sql = \"DROP VIEW IF EXISTS StateSalesView;\"\n",
    "my_sql['setup'].append(sql)\n",
    "curs.execute(sql)\n",
    "\n",
    "sql = '''\n",
    "CREATE VIEW StateSalesView AS\n",
    "WITH StateSales AS (\n",
    "    SELECT tZip.state_id,\n",
    "        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales\n",
    "    FROM tZip\n",
    "        JOIN tCust USING (zip)\n",
    "        JOIN tOrder USING (cust_id)\n",
    "        JOIN tOrderDetail USING (order_id)\n",
    "        JOIN tProd USING (prod_id)\n",
    "    WHERE strftime('%Y-%m', tOrder.date) = '2019-09'\n",
    "    GROUP BY tZip.state_id\n",
    ")\n",
    "SELECT s.state_id,\n",
    "    IFNULL(ss.total_sales, 0) AS total_sales\n",
    "FROM (\n",
    "    SELECT DISTINCT state_id FROM tZip\n",
    ") s\n",
    "LEFT JOIN StateSales ss USING (state_id)\n",
    "ORDER BY s.state_id;\n",
    "'''\n",
    "my_sql['setup'].append(sql)\n",
    "curs.execute(sql)\n",
    "\n",
    "\n",
    "curs.execute(\"DROP VIEW IF EXISTS vOrder_DatesParsed;\")\n",
    "sql = \"\"\"\n",
    "CREATE VIEW vOrder_DatesParsed as\n",
    "SELECT *, SUBSTR(date, 1, 4) as year,\n",
    "          SUBSTR(date, 6, 2) as month,\n",
    "          SUBSTR(date, 9, 2) as day,\n",
    "          SUBSTR(date, 1, 7) as year_month\n",
    "FROM tOrder\n",
    ";\"\"\"\n",
    "curs.execute(sql)"
   ]
  },
  {
   "cell_type": "raw",
   "id": "450148ee-3075-4623-bf03-6a003a20c3fa",
   "metadata": {},
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "5a3970d4-c3b8-4a12-8547-ac780bcf8949",
   "metadata": {},
   "source": [
    "---\n",
    "1) Generate a summary, by month and year of how our store is performing.\n",
    "\n",
    "Have your query return the following:\n",
    " - year_month (as a single column, like YYYY-MM)\n",
    " - Sales: total sales for the month (i.e., sum of qty * unit price)\n",
    " - NumOrders: number of orders placed for the month\n",
    " - NumCust: number of _distinct_ customers who made a purchase (i.e. only count the customer at most once per month)\n",
    " - OrdersPerCust: average number of orders per customer (i.e. NumOrders/NumCust)\n",
    " - SalesPerCust: average sales per customer (i.e. Sales/NumCust)\n",
    " - SalesPerOrder: average sales per order (i.e. Sales/NumOrders)\n",
    "\n",
    "Sort the results should by year_month, in ascending order.\n",
    "\n",
    "_Hint: Watch out for integer division!_"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5c67c971-5f4b-4223-842b-e8e68aa9b50f",
   "metadata": {},
   "source": [
    "DONE"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "07a20ba5-92ab-4415-b5eb-9296e566d750",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year_month</th>\n",
       "      <th>Sales</th>\n",
       "      <th>NumOrders</th>\n",
       "      <th>NumCust</th>\n",
       "      <th>OrdersPerCust</th>\n",
       "      <th>SalesPerCust</th>\n",
       "      <th>SalesPerOrder</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2019-01</td>\n",
       "      <td>68464.61</td>\n",
       "      <td>91</td>\n",
       "      <td>85</td>\n",
       "      <td>1.070588</td>\n",
       "      <td>805.466000</td>\n",
       "      <td>752.358352</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2019-02</td>\n",
       "      <td>55560.32</td>\n",
       "      <td>80</td>\n",
       "      <td>73</td>\n",
       "      <td>1.095890</td>\n",
       "      <td>761.100274</td>\n",
       "      <td>694.504000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2019-03</td>\n",
       "      <td>19191.68</td>\n",
       "      <td>51</td>\n",
       "      <td>49</td>\n",
       "      <td>1.040816</td>\n",
       "      <td>391.666939</td>\n",
       "      <td>376.307451</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2019-04</td>\n",
       "      <td>20912.07</td>\n",
       "      <td>48</td>\n",
       "      <td>46</td>\n",
       "      <td>1.043478</td>\n",
       "      <td>454.610217</td>\n",
       "      <td>435.668125</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2019-05</td>\n",
       "      <td>11973.34</td>\n",
       "      <td>50</td>\n",
       "      <td>46</td>\n",
       "      <td>1.086957</td>\n",
       "      <td>260.290000</td>\n",
       "      <td>239.466800</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>2019-06</td>\n",
       "      <td>13737.30</td>\n",
       "      <td>43</td>\n",
       "      <td>41</td>\n",
       "      <td>1.048780</td>\n",
       "      <td>335.056098</td>\n",
       "      <td>319.472093</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>2019-07</td>\n",
       "      <td>22095.05</td>\n",
       "      <td>45</td>\n",
       "      <td>41</td>\n",
       "      <td>1.097561</td>\n",
       "      <td>538.903659</td>\n",
       "      <td>491.001111</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>2019-08</td>\n",
       "      <td>15675.05</td>\n",
       "      <td>51</td>\n",
       "      <td>49</td>\n",
       "      <td>1.040816</td>\n",
       "      <td>319.898980</td>\n",
       "      <td>307.353922</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>2019-09</td>\n",
       "      <td>9360.38</td>\n",
       "      <td>40</td>\n",
       "      <td>39</td>\n",
       "      <td>1.025641</td>\n",
       "      <td>240.009744</td>\n",
       "      <td>234.009500</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>2019-10</td>\n",
       "      <td>48411.35</td>\n",
       "      <td>58</td>\n",
       "      <td>51</td>\n",
       "      <td>1.137255</td>\n",
       "      <td>949.242157</td>\n",
       "      <td>834.678448</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>2019-11</td>\n",
       "      <td>26242.52</td>\n",
       "      <td>60</td>\n",
       "      <td>55</td>\n",
       "      <td>1.090909</td>\n",
       "      <td>477.136727</td>\n",
       "      <td>437.375333</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>2019-12</td>\n",
       "      <td>17120.21</td>\n",
       "      <td>59</td>\n",
       "      <td>50</td>\n",
       "      <td>1.180000</td>\n",
       "      <td>342.404200</td>\n",
       "      <td>290.173051</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>2020-01</td>\n",
       "      <td>26483.42</td>\n",
       "      <td>54</td>\n",
       "      <td>52</td>\n",
       "      <td>1.038462</td>\n",
       "      <td>509.296538</td>\n",
       "      <td>490.433704</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>2020-02</td>\n",
       "      <td>23473.81</td>\n",
       "      <td>52</td>\n",
       "      <td>48</td>\n",
       "      <td>1.083333</td>\n",
       "      <td>489.037708</td>\n",
       "      <td>451.419423</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>2020-03</td>\n",
       "      <td>44350.50</td>\n",
       "      <td>61</td>\n",
       "      <td>56</td>\n",
       "      <td>1.089286</td>\n",
       "      <td>791.973214</td>\n",
       "      <td>727.057377</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>2020-04</td>\n",
       "      <td>43669.09</td>\n",
       "      <td>74</td>\n",
       "      <td>67</td>\n",
       "      <td>1.104478</td>\n",
       "      <td>651.777463</td>\n",
       "      <td>590.122838</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>2020-05</td>\n",
       "      <td>62960.70</td>\n",
       "      <td>84</td>\n",
       "      <td>75</td>\n",
       "      <td>1.120000</td>\n",
       "      <td>839.476000</td>\n",
       "      <td>749.532143</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>2020-06</td>\n",
       "      <td>55861.65</td>\n",
       "      <td>80</td>\n",
       "      <td>70</td>\n",
       "      <td>1.142857</td>\n",
       "      <td>798.023571</td>\n",
       "      <td>698.270625</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>2020-07</td>\n",
       "      <td>73209.88</td>\n",
       "      <td>77</td>\n",
       "      <td>65</td>\n",
       "      <td>1.184615</td>\n",
       "      <td>1126.305846</td>\n",
       "      <td>950.777662</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>2020-08</td>\n",
       "      <td>105795.72</td>\n",
       "      <td>96</td>\n",
       "      <td>79</td>\n",
       "      <td>1.215190</td>\n",
       "      <td>1339.186329</td>\n",
       "      <td>1102.038750</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>2020-09</td>\n",
       "      <td>83470.62</td>\n",
       "      <td>93</td>\n",
       "      <td>85</td>\n",
       "      <td>1.094118</td>\n",
       "      <td>982.007294</td>\n",
       "      <td>897.533548</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>2020-10</td>\n",
       "      <td>68566.76</td>\n",
       "      <td>100</td>\n",
       "      <td>91</td>\n",
       "      <td>1.098901</td>\n",
       "      <td>753.480879</td>\n",
       "      <td>685.667600</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>2020-11</td>\n",
       "      <td>58551.46</td>\n",
       "      <td>88</td>\n",
       "      <td>81</td>\n",
       "      <td>1.086420</td>\n",
       "      <td>722.857531</td>\n",
       "      <td>665.357500</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>2020-12</td>\n",
       "      <td>91301.80</td>\n",
       "      <td>98</td>\n",
       "      <td>85</td>\n",
       "      <td>1.152941</td>\n",
       "      <td>1074.138824</td>\n",
       "      <td>931.651020</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>2021-01</td>\n",
       "      <td>104310.14</td>\n",
       "      <td>104</td>\n",
       "      <td>85</td>\n",
       "      <td>1.223529</td>\n",
       "      <td>1227.178118</td>\n",
       "      <td>1002.982115</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>2021-02</td>\n",
       "      <td>73437.94</td>\n",
       "      <td>77</td>\n",
       "      <td>66</td>\n",
       "      <td>1.166667</td>\n",
       "      <td>1112.696061</td>\n",
       "      <td>953.739481</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>2021-03</td>\n",
       "      <td>107697.80</td>\n",
       "      <td>126</td>\n",
       "      <td>101</td>\n",
       "      <td>1.247525</td>\n",
       "      <td>1066.314851</td>\n",
       "      <td>854.744444</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>2021-04</td>\n",
       "      <td>141326.84</td>\n",
       "      <td>140</td>\n",
       "      <td>113</td>\n",
       "      <td>1.238938</td>\n",
       "      <td>1250.680000</td>\n",
       "      <td>1009.477429</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>28</th>\n",
       "      <td>2021-05</td>\n",
       "      <td>154028.29</td>\n",
       "      <td>135</td>\n",
       "      <td>115</td>\n",
       "      <td>1.173913</td>\n",
       "      <td>1339.376435</td>\n",
       "      <td>1140.950296</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>29</th>\n",
       "      <td>2021-06</td>\n",
       "      <td>154172.49</td>\n",
       "      <td>124</td>\n",
       "      <td>98</td>\n",
       "      <td>1.265306</td>\n",
       "      <td>1573.188673</td>\n",
       "      <td>1243.326532</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>2021-07</td>\n",
       "      <td>200275.39</td>\n",
       "      <td>154</td>\n",
       "      <td>132</td>\n",
       "      <td>1.166667</td>\n",
       "      <td>1517.237803</td>\n",
       "      <td>1300.489545</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>2021-08</td>\n",
       "      <td>215386.24</td>\n",
       "      <td>161</td>\n",
       "      <td>126</td>\n",
       "      <td>1.277778</td>\n",
       "      <td>1709.414603</td>\n",
       "      <td>1337.802733</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>2021-09</td>\n",
       "      <td>101263.76</td>\n",
       "      <td>108</td>\n",
       "      <td>92</td>\n",
       "      <td>1.173913</td>\n",
       "      <td>1100.693043</td>\n",
       "      <td>937.627407</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>2021-10</td>\n",
       "      <td>251768.12</td>\n",
       "      <td>165</td>\n",
       "      <td>127</td>\n",
       "      <td>1.299213</td>\n",
       "      <td>1982.426142</td>\n",
       "      <td>1525.867394</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   year_month      Sales  NumOrders  NumCust  OrdersPerCust  SalesPerCust  \\\n",
       "0     2019-01   68464.61         91       85       1.070588    805.466000   \n",
       "1     2019-02   55560.32         80       73       1.095890    761.100274   \n",
       "2     2019-03   19191.68         51       49       1.040816    391.666939   \n",
       "3     2019-04   20912.07         48       46       1.043478    454.610217   \n",
       "4     2019-05   11973.34         50       46       1.086957    260.290000   \n",
       "5     2019-06   13737.30         43       41       1.048780    335.056098   \n",
       "6     2019-07   22095.05         45       41       1.097561    538.903659   \n",
       "7     2019-08   15675.05         51       49       1.040816    319.898980   \n",
       "8     2019-09    9360.38         40       39       1.025641    240.009744   \n",
       "9     2019-10   48411.35         58       51       1.137255    949.242157   \n",
       "10    2019-11   26242.52         60       55       1.090909    477.136727   \n",
       "11    2019-12   17120.21         59       50       1.180000    342.404200   \n",
       "12    2020-01   26483.42         54       52       1.038462    509.296538   \n",
       "13    2020-02   23473.81         52       48       1.083333    489.037708   \n",
       "14    2020-03   44350.50         61       56       1.089286    791.973214   \n",
       "15    2020-04   43669.09         74       67       1.104478    651.777463   \n",
       "16    2020-05   62960.70         84       75       1.120000    839.476000   \n",
       "17    2020-06   55861.65         80       70       1.142857    798.023571   \n",
       "18    2020-07   73209.88         77       65       1.184615   1126.305846   \n",
       "19    2020-08  105795.72         96       79       1.215190   1339.186329   \n",
       "20    2020-09   83470.62         93       85       1.094118    982.007294   \n",
       "21    2020-10   68566.76        100       91       1.098901    753.480879   \n",
       "22    2020-11   58551.46         88       81       1.086420    722.857531   \n",
       "23    2020-12   91301.80         98       85       1.152941   1074.138824   \n",
       "24    2021-01  104310.14        104       85       1.223529   1227.178118   \n",
       "25    2021-02   73437.94         77       66       1.166667   1112.696061   \n",
       "26    2021-03  107697.80        126      101       1.247525   1066.314851   \n",
       "27    2021-04  141326.84        140      113       1.238938   1250.680000   \n",
       "28    2021-05  154028.29        135      115       1.173913   1339.376435   \n",
       "29    2021-06  154172.49        124       98       1.265306   1573.188673   \n",
       "30    2021-07  200275.39        154      132       1.166667   1517.237803   \n",
       "31    2021-08  215386.24        161      126       1.277778   1709.414603   \n",
       "32    2021-09  101263.76        108       92       1.173913   1100.693043   \n",
       "33    2021-10  251768.12        165      127       1.299213   1982.426142   \n",
       "\n",
       "    SalesPerOrder  \n",
       "0      752.358352  \n",
       "1      694.504000  \n",
       "2      376.307451  \n",
       "3      435.668125  \n",
       "4      239.466800  \n",
       "5      319.472093  \n",
       "6      491.001111  \n",
       "7      307.353922  \n",
       "8      234.009500  \n",
       "9      834.678448  \n",
       "10     437.375333  \n",
       "11     290.173051  \n",
       "12     490.433704  \n",
       "13     451.419423  \n",
       "14     727.057377  \n",
       "15     590.122838  \n",
       "16     749.532143  \n",
       "17     698.270625  \n",
       "18     950.777662  \n",
       "19    1102.038750  \n",
       "20     897.533548  \n",
       "21     685.667600  \n",
       "22     665.357500  \n",
       "23     931.651020  \n",
       "24    1002.982115  \n",
       "25     953.739481  \n",
       "26     854.744444  \n",
       "27    1009.477429  \n",
       "28    1140.950296  \n",
       "29    1243.326532  \n",
       "30    1300.489545  \n",
       "31    1337.802733  \n",
       "32     937.627407  \n",
       "33    1525.867394  "
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql1 = '''\n",
    "WITH TotalsPerMonth AS (\n",
    "    SELECT\n",
    "        strftime('%Y-%m', date) AS year_month,\n",
    "        sum(qty * unit_price) AS TotalSales,\n",
    "        count(DISTINCT order_id) AS NumOrders,\n",
    "        count(DISTINCT cust_id) AS NumCust\n",
    "    FROM tOrder\n",
    "    JOIN tOrderDetail USING(order_id)\n",
    "    JOIN tProd USING(prod_id)\n",
    "    GROUP BY year_month\n",
    ")\n",
    "SELECT\n",
    "    year_month,\n",
    "    sum(TotalSales) AS Sales,\n",
    "    sum(NumOrders) AS NumOrders,\n",
    "    sum(NumCust) AS NumCust,\n",
    "    AVG(NumOrders * 1.0 / NumCust) AS OrdersPerCust,\n",
    "    AVG(TotalSales * 1.0 / NumCust) AS SalesPerCust,\n",
    "    AVG(TotalSales * 1.0 / NumOrders) AS SalesPerOrder\n",
    "FROM TotalsPerMonth\n",
    "GROUP BY year_month\n",
    "ORDER BY year_month ASC;\n",
    "'''\n",
    "\n",
    "pd.read_sql(sql1, conn) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "8ea158c9-67ab-4c51-854e-a47b4dafe1dc",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q1']['sql'] = sql1"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "212acca8-cbeb-4f60-bead-e2cf544cc36f",
   "metadata": {},
   "source": [
    "---\n",
    "2) In which month did we have the lowest total sales?\n",
    "\n",
    "Return one record with:\n",
    "- year_month (as a single column, like YYYY-MM)\n",
    "- sales (sum of qty * unit_price)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6a30cdb7-3d5a-48ed-be1f-880847c5d968",
   "metadata": {},
   "source": [
    "DONE"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "b0d0bff9-0581-43aa-9fb9-4573d626207f",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year_month</th>\n",
       "      <th>sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2019-09</td>\n",
       "      <td>9360.38</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  year_month    sales\n",
       "0    2019-09  9360.38"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql2 = '''\n",
    "SELECT\n",
    "    strftime('%Y-%m', date) AS year_month,\n",
    "    SUM(tOrderDetail.qty * tProd.unit_price) AS sales\n",
    "FROM\n",
    "    tOrder\n",
    "    JOIN tOrderDetail USING (order_id)\n",
    "    JOIN tProd USING (prod_id)\n",
    "    JOIN tCust USING (cust_id)\n",
    "GROUP BY year_month\n",
    "ORDER BY sales ASC\n",
    "LIMIT 1\n",
    ";'''\n",
    "pd.read_sql(sql2, conn)  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "972d1c56-47c8-4d65-bf8f-443ff95ceaa4",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q2']['sql'] = sql2"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "85321a20-c785-4163-8a5f-81e6d903ee25",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "3. In the month determined from the previous question, generate a list of our total sales by state. Make sure that all states are included, even if they have no sales (50 states + PR and DC = 52 total records). For states having 0 sales, return 0, not NULL or NaN.\n",
    "\n",
    "Return:\n",
    "\n",
    "- state_id\n",
    "- Total sales for the month in question\n",
    "\n",
    "Order the results by the state_id, ascending"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6e4f1f80-f16c-4359-a3cc-c57f85a6353b",
   "metadata": {},
   "source": [
    "Done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "0738c424-e6b7-4ce9-b584-c5eccd32ac9a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>state_id</th>\n",
       "      <th>total_sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>AK</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>AL</td>\n",
       "      <td>28.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>AR</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>AZ</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>CA</td>\n",
       "      <td>557.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>CO</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>CT</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>DC</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>DE</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>FL</td>\n",
       "      <td>414.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>GA</td>\n",
       "      <td>15.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>HI</td>\n",
       "      <td>65.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>IA</td>\n",
       "      <td>351.84</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>ID</td>\n",
       "      <td>110.85</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>IL</td>\n",
       "      <td>58.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>IN</td>\n",
       "      <td>79.93</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>KS</td>\n",
       "      <td>198.35</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>KY</td>\n",
       "      <td>37.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>LA</td>\n",
       "      <td>15.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>MA</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>MD</td>\n",
       "      <td>2525.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>ME</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>MI</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>MN</td>\n",
       "      <td>333.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>MO</td>\n",
       "      <td>1.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>MS</td>\n",
       "      <td>99.02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>MT</td>\n",
       "      <td>18.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>NC</td>\n",
       "      <td>524.62</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>28</th>\n",
       "      <td>ND</td>\n",
       "      <td>1.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>29</th>\n",
       "      <td>NE</td>\n",
       "      <td>1422.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>NH</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>NJ</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>NM</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>NV</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>34</th>\n",
       "      <td>NY</td>\n",
       "      <td>0.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>35</th>\n",
       "      <td>OH</td>\n",
       "      <td>822.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>36</th>\n",
       "      <td>OK</td>\n",
       "      <td>8.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>37</th>\n",
       "      <td>OR</td>\n",
       "      <td>125.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>38</th>\n",
       "      <td>PA</td>\n",
       "      <td>26.91</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>39</th>\n",
       "      <td>PR</td>\n",
       "      <td>240.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>40</th>\n",
       "      <td>RI</td>\n",
       "      <td>173.27</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>41</th>\n",
       "      <td>SC</td>\n",
       "      <td>27.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>42</th>\n",
       "      <td>SD</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>43</th>\n",
       "      <td>TN</td>\n",
       "      <td>425.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>44</th>\n",
       "      <td>TX</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>45</th>\n",
       "      <td>UT</td>\n",
       "      <td>12.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>46</th>\n",
       "      <td>VA</td>\n",
       "      <td>365.65</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47</th>\n",
       "      <td>VT</td>\n",
       "      <td>275.87</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>48</th>\n",
       "      <td>WA</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>49</th>\n",
       "      <td>WI</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50</th>\n",
       "      <td>WV</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>51</th>\n",
       "      <td>WY</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   state_id  total_sales\n",
       "0        AK         0.00\n",
       "1        AL        28.00\n",
       "2        AR         0.00\n",
       "3        AZ         0.00\n",
       "4        CA       557.00\n",
       "5        CO         0.00\n",
       "6        CT         0.00\n",
       "7        DC         0.00\n",
       "8        DE         0.00\n",
       "9        FL       414.00\n",
       "10       GA        15.00\n",
       "11       HI        65.94\n",
       "12       IA       351.84\n",
       "13       ID       110.85\n",
       "14       IL        58.00\n",
       "15       IN        79.93\n",
       "16       KS       198.35\n",
       "17       KY        37.00\n",
       "18       LA        15.00\n",
       "19       MA         0.00\n",
       "20       MD      2525.94\n",
       "21       ME         0.00\n",
       "22       MI         0.00\n",
       "23       MN       333.00\n",
       "24       MO         1.00\n",
       "25       MS        99.02\n",
       "26       MT        18.00\n",
       "27       NC       524.62\n",
       "28       ND         1.25\n",
       "29       NE      1422.00\n",
       "30       NH         0.00\n",
       "31       NJ         0.00\n",
       "32       NM         0.00\n",
       "33       NV         0.00\n",
       "34       NY         0.25\n",
       "35       OH       822.88\n",
       "36       OK         8.00\n",
       "37       OR       125.94\n",
       "38       PA        26.91\n",
       "39       PR       240.00\n",
       "40       RI       173.27\n",
       "41       SC        27.99\n",
       "42       SD         0.00\n",
       "43       TN       425.88\n",
       "44       TX         0.00\n",
       "45       UT        12.00\n",
       "46       VA       365.65\n",
       "47       VT       275.87\n",
       "48       WA         0.00\n",
       "49       WI         0.00\n",
       "50       WV         0.00\n",
       "51       WY         0.00"
      ]
     },
     "execution_count": 17,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql3 = '''\n",
    "SELECT\n",
    "    s.state_id,\n",
    "    IFNULL(ss.total_sales, 0) AS total_sales\n",
    "FROM (\n",
    "    SELECT DISTINCT state_id FROM tZip\n",
    ") s\n",
    "LEFT JOIN StateSalesView ss USING (state_id)\n",
    "ORDER BY s.state_id;\n",
    "'''\n",
    "pd.read_sql(sql3, conn)  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e5008545-4127-465d-a245-43c728e0f9d0",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "b235ac57-9485-469a-9c20-1a601712a650",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q3']['sql'] = sql3"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9f6fb11c-24a5-4015-b8c7-92e0e94cb495",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "4. For the list of states above that had 0 sales, generate a list of all the customers in those states, along with how much they have bought from us since then.\n",
    "\n",
    "Return:\n",
    "- cust_id\n",
    "- first\n",
    "- last\n",
    "- addr\n",
    "- city\n",
    "- st\n",
    "- zip\n",
    "- the customer's total sales from all months after the month from question 4\n",
    "\n",
    "Order the results by cust_id, ascending"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4a7a8126-8a13-45d3-b15c-70087bf2fade",
   "metadata": {
    "tags": []
   },
   "source": [
    "Done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "2a9bff0d-be67-4b95-b42d-8d2d3d99518b",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cust_id</th>\n",
       "      <th>first</th>\n",
       "      <th>last</th>\n",
       "      <th>addr</th>\n",
       "      <th>city</th>\n",
       "      <th>st</th>\n",
       "      <th>zip</th>\n",
       "      <th>customer_total_sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>3</td>\n",
       "      <td>Dodonna</td>\n",
       "      <td>Garza</td>\n",
       "      <td>3639 Briarwood Court</td>\n",
       "      <td>Tarzan</td>\n",
       "      <td>TX</td>\n",
       "      <td>79783</td>\n",
       "      <td>364.90</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>6</td>\n",
       "      <td>Motti</td>\n",
       "      <td>Hunt</td>\n",
       "      <td>1919 Smith Street</td>\n",
       "      <td>Hamden</td>\n",
       "      <td>CT</td>\n",
       "      <td>6514</td>\n",
       "      <td>5465.67</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>7</td>\n",
       "      <td>Mace Windu</td>\n",
       "      <td>Woodward</td>\n",
       "      <td>5655 Jefferson Court</td>\n",
       "      <td>Milan</td>\n",
       "      <td>NM</td>\n",
       "      <td>87021</td>\n",
       "      <td>9422.33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>11</td>\n",
       "      <td>Senator Ask Aak</td>\n",
       "      <td>Chen</td>\n",
       "      <td>2027 Pheasant Run</td>\n",
       "      <td>Wayne</td>\n",
       "      <td>NJ</td>\n",
       "      <td>7470</td>\n",
       "      <td>11028.03</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>12</td>\n",
       "      <td>Jabba</td>\n",
       "      <td>Oneill</td>\n",
       "      <td>9371 Walnut Street</td>\n",
       "      <td>Swampscott</td>\n",
       "      <td>MA</td>\n",
       "      <td>1907</td>\n",
       "      <td>9848.63</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>113</th>\n",
       "      <td>297</td>\n",
       "      <td>Tey How</td>\n",
       "      <td>Rodriguez</td>\n",
       "      <td>9164 Madison Street</td>\n",
       "      <td>Brick</td>\n",
       "      <td>NJ</td>\n",
       "      <td>8723</td>\n",
       "      <td>4347.75</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>114</th>\n",
       "      <td>301</td>\n",
       "      <td>Rabe</td>\n",
       "      <td>Mitchell</td>\n",
       "      <td>8021 Heather Lane</td>\n",
       "      <td>Pindall</td>\n",
       "      <td>AR</td>\n",
       "      <td>72669</td>\n",
       "      <td>8828.98</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>115</th>\n",
       "      <td>302</td>\n",
       "      <td>Taun We</td>\n",
       "      <td>Miller</td>\n",
       "      <td>4011 Sycamore Drive</td>\n",
       "      <td>Yellow Jacket</td>\n",
       "      <td>CO</td>\n",
       "      <td>81335</td>\n",
       "      <td>11850.42</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>116</th>\n",
       "      <td>305</td>\n",
       "      <td>Dodonna</td>\n",
       "      <td>Francis</td>\n",
       "      <td>8070 Briarwood Court</td>\n",
       "      <td>Buckland</td>\n",
       "      <td>AK</td>\n",
       "      <td>99727</td>\n",
       "      <td>4878.76</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>117</th>\n",
       "      <td>308</td>\n",
       "      <td>Unkar Plutt</td>\n",
       "      <td>Mcbride</td>\n",
       "      <td>9487 Devonshire Drive</td>\n",
       "      <td>East Orange</td>\n",
       "      <td>NJ</td>\n",
       "      <td>7018</td>\n",
       "      <td>2486.38</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>118 rows Ã— 8 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     cust_id            first       last                   addr  \\\n",
       "0          3          Dodonna      Garza   3639 Briarwood Court   \n",
       "1          6            Motti       Hunt      1919 Smith Street   \n",
       "2          7       Mace Windu   Woodward   5655 Jefferson Court   \n",
       "3         11  Senator Ask Aak       Chen      2027 Pheasant Run   \n",
       "4         12            Jabba     Oneill     9371 Walnut Street   \n",
       "..       ...              ...        ...                    ...   \n",
       "113      297          Tey How  Rodriguez    9164 Madison Street   \n",
       "114      301             Rabe   Mitchell      8021 Heather Lane   \n",
       "115      302          Taun We     Miller    4011 Sycamore Drive   \n",
       "116      305          Dodonna    Francis   8070 Briarwood Court   \n",
       "117      308      Unkar Plutt    Mcbride  9487 Devonshire Drive   \n",
       "\n",
       "              city  st    zip  customer_total_sales  \n",
       "0           Tarzan  TX  79783                364.90  \n",
       "1           Hamden  CT   6514               5465.67  \n",
       "2            Milan  NM  87021               9422.33  \n",
       "3            Wayne  NJ   7470              11028.03  \n",
       "4       Swampscott  MA   1907               9848.63  \n",
       "..             ...  ..    ...                   ...  \n",
       "113          Brick  NJ   8723               4347.75  \n",
       "114        Pindall  AR  72669               8828.98  \n",
       "115  Yellow Jacket  CO  81335              11850.42  \n",
       "116       Buckland  AK  99727               4878.76  \n",
       "117    East Orange  NJ   7018               2486.38  \n",
       "\n",
       "[118 rows x 8 columns]"
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql4 = '''\n",
    "WITH CustomerSales AS (\n",
    "    SELECT\n",
    "        tCust.cust_id,\n",
    "        tCust.first,\n",
    "        tCust.last,\n",
    "        tCust.addr,\n",
    "        tZip.city,\n",
    "        tZip.state_id AS st,\n",
    "        tCust.zip,\n",
    "        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales\n",
    "    FROM\n",
    "        tCust\n",
    "        JOIN tZip USING (zip)\n",
    "        LEFT JOIN tOrder USING (cust_id)\n",
    "        LEFT JOIN tOrderDetail USING (order_id)\n",
    "        LEFT JOIN tProd USING (prod_id)\n",
    "    WHERE\n",
    "        strftime('%Y-%m', IFNULL(tOrder.date, '2019-09')) >= '2019-09'\n",
    "    GROUP BY\n",
    "        tCust.cust_id\n",
    ")\n",
    "SELECT\n",
    "    cs.cust_id,\n",
    "    cs.first,\n",
    "    cs.last,\n",
    "    cs.addr,\n",
    "    cs.city,\n",
    "    cs.st,\n",
    "    cs.zip,\n",
    "    cs.total_sales AS customer_total_sales\n",
    "FROM\n",
    "    CustomerSales cs\n",
    "    JOIN StateSalesView ssv ON cs.st = ssv.state_id\n",
    "WHERE\n",
    "    ssv.total_sales = 0\n",
    "ORDER BY\n",
    "    cs.cust_id ASC;\n",
    "\n",
    "    '''\n",
    "pd.read_sql(sql4, conn)  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "4ff46f7c-878b-4aa8-b85d-e565ae0077d5",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q4']['sql'] = sql4"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bb87300d-d6d3-4272-aedd-f85c48807f45",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "5) Get a list of customers who did not purchase anything in the most recent month of data, along with their average sales for all months prior.\n",
    "\n",
    "Return:\n",
    "\n",
    "- customer id\n",
    "- name, address, zip, city, st (abbreviation is fine)\n",
    "- average sales for all months prior (divide by N-1, where N is the total number of months in the database)\n",
    "\n",
    "Order the results with the largest average monthly sales on top."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a21c2f58-cf51-456f-8125-186110941b2a",
   "metadata": {},
   "source": [
    "DONE"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6a313e23-500a-47cb-a403-549c93c7cbc6",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "6ee52c38-1b17-43ca-8429-44183242c29e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cust_id</th>\n",
       "      <th>name</th>\n",
       "      <th>addr</th>\n",
       "      <th>zip</th>\n",
       "      <th>city</th>\n",
       "      <th>st</th>\n",
       "      <th>year_month</th>\n",
       "      <th>avg_sales_prior</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>245</td>\n",
       "      <td>Lieutenant Mitaka Oneill</td>\n",
       "      <td>1110 2nd Street</td>\n",
       "      <td>2836</td>\n",
       "      <td>Kenyon</td>\n",
       "      <td>RI</td>\n",
       "      <td>2021-08</td>\n",
       "      <td>205.875455</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>188</td>\n",
       "      <td>On Medon Curtis</td>\n",
       "      <td>1971 Lake Street</td>\n",
       "      <td>74570</td>\n",
       "      <td>Stuart</td>\n",
       "      <td>OK</td>\n",
       "      <td>2021-09</td>\n",
       "      <td>187.818485</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>22</td>\n",
       "      <td>Rieekan Jimenez</td>\n",
       "      <td>5165 5th Street</td>\n",
       "      <td>43149</td>\n",
       "      <td>Rockbridge</td>\n",
       "      <td>OH</td>\n",
       "      <td>2021-08</td>\n",
       "      <td>178.892121</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>198</td>\n",
       "      <td>Lama Su Vincent</td>\n",
       "      <td>2114 4th Street</td>\n",
       "      <td>23866</td>\n",
       "      <td>Ivor</td>\n",
       "      <td>VA</td>\n",
       "      <td>2021-07</td>\n",
       "      <td>160.983636</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>202</td>\n",
       "      <td>Gold Leader Elliott</td>\n",
       "      <td>9326 Sycamore Street</td>\n",
       "      <td>25938</td>\n",
       "      <td>Victor</td>\n",
       "      <td>WV</td>\n",
       "      <td>2021-08</td>\n",
       "      <td>153.463939</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>178</th>\n",
       "      <td>153</td>\n",
       "      <td>Padme Todd</td>\n",
       "      <td>9619 Beechwood Drive</td>\n",
       "      <td>6615</td>\n",
       "      <td>Stratford</td>\n",
       "      <td>CT</td>\n",
       "      <td>2021-08</td>\n",
       "      <td>1.694848</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>179</th>\n",
       "      <td>48</td>\n",
       "      <td>Tey How Barker</td>\n",
       "      <td>6169 Beechwood Drive</td>\n",
       "      <td>717</td>\n",
       "      <td>Ponce</td>\n",
       "      <td>PR</td>\n",
       "      <td>2021-06</td>\n",
       "      <td>0.927576</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>180</th>\n",
       "      <td>113</td>\n",
       "      <td>Colonel Datoo Schmidt</td>\n",
       "      <td>8706 Devonshire Drive</td>\n",
       "      <td>94523</td>\n",
       "      <td>Pleasant Hill</td>\n",
       "      <td>CA</td>\n",
       "      <td>2020-09</td>\n",
       "      <td>0.453030</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>181</th>\n",
       "      <td>116</td>\n",
       "      <td>Bala-Tik Schmidt</td>\n",
       "      <td>3353 Front Street</td>\n",
       "      <td>6053</td>\n",
       "      <td>New Britain</td>\n",
       "      <td>CT</td>\n",
       "      <td>2021-09</td>\n",
       "      <td>0.143939</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>182</th>\n",
       "      <td>205</td>\n",
       "      <td>Shmi Aguilar</td>\n",
       "      <td>7723 Smith Street</td>\n",
       "      <td>29123</td>\n",
       "      <td>Pelion</td>\n",
       "      <td>SC</td>\n",
       "      <td>2020-07</td>\n",
       "      <td>0.018182</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>183 rows Ã— 8 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     cust_id                      name                   addr    zip  \\\n",
       "0        245  Lieutenant Mitaka Oneill        1110 2nd Street   2836   \n",
       "1        188           On Medon Curtis       1971 Lake Street  74570   \n",
       "2         22           Rieekan Jimenez        5165 5th Street  43149   \n",
       "3        198           Lama Su Vincent        2114 4th Street  23866   \n",
       "4        202       Gold Leader Elliott   9326 Sycamore Street  25938   \n",
       "..       ...                       ...                    ...    ...   \n",
       "178      153                Padme Todd   9619 Beechwood Drive   6615   \n",
       "179       48            Tey How Barker   6169 Beechwood Drive    717   \n",
       "180      113     Colonel Datoo Schmidt  8706 Devonshire Drive  94523   \n",
       "181      116          Bala-Tik Schmidt      3353 Front Street   6053   \n",
       "182      205              Shmi Aguilar      7723 Smith Street  29123   \n",
       "\n",
       "              city  st year_month  avg_sales_prior  \n",
       "0           Kenyon  RI    2021-08       205.875455  \n",
       "1           Stuart  OK    2021-09       187.818485  \n",
       "2       Rockbridge  OH    2021-08       178.892121  \n",
       "3             Ivor  VA    2021-07       160.983636  \n",
       "4           Victor  WV    2021-08       153.463939  \n",
       "..             ...  ..        ...              ...  \n",
       "178      Stratford  CT    2021-08         1.694848  \n",
       "179          Ponce  PR    2021-06         0.927576  \n",
       "180  Pleasant Hill  CA    2020-09         0.453030  \n",
       "181    New Britain  CT    2021-09         0.143939  \n",
       "182         Pelion  SC    2020-07         0.018182  \n",
       "\n",
       "[183 rows x 8 columns]"
      ]
     },
     "execution_count": 21,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql5='''\n",
    "WITH LatestMonth AS (\n",
    "    SELECT MAX(strftime('%Y-%m', date)) AS latest_month\n",
    "    FROM tOrder\n",
    "),\n",
    "CustomersWithoutPurchase AS (\n",
    "    SELECT DISTINCT tCust.cust_id\n",
    "    FROM tCust\n",
    "    WHERE tCust.cust_id NOT IN (\n",
    "        SELECT DISTINCT cust_id\n",
    "        FROM tOrder\n",
    "        WHERE strftime('%Y-%m', date) = (SELECT latest_month FROM LatestMonth)\n",
    "    )\n",
    "),\n",
    "Months AS (\n",
    "    SELECT COUNT(DISTINCT strftime('%Y-%m', date)) - 1 AS NumMonths\n",
    "    FROM tOrder\n",
    "),\n",
    "CustomerSales AS (\n",
    "    SELECT\n",
    "        tCust.cust_id,\n",
    "        tCust.first || ' ' || tCust.last AS name,\n",
    "        tCust.addr,\n",
    "        tZip.zip,\n",
    "        tZip.city,\n",
    "        tZip.state_id AS st,\n",
    "        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales,\n",
    "        strftime('%Y-%m', IFNULL(tOrder.date, '0000-00-00')) AS year_month\n",
    "    FROM\n",
    "        tCust\n",
    "        JOIN tZip USING (zip)\n",
    "        LEFT JOIN tOrder USING (cust_id)\n",
    "        LEFT JOIN tOrderDetail USING (order_id)\n",
    "        LEFT JOIN tProd USING (prod_id)\n",
    "    WHERE\n",
    "        tCust.cust_id IN (SELECT cust_id FROM CustomersWithoutPurchase)\n",
    "        AND (strftime('%Y-%m', IFNULL(tOrder.date, '0000-00-00')) < (SELECT latest_month FROM LatestMonth))\n",
    "    GROUP BY\n",
    "        tCust.cust_id, year_month\n",
    "),\n",
    "AverageSales AS (\n",
    "    SELECT\n",
    "        cs.cust_id,\n",
    "        cs.name,\n",
    "        cs.addr,\n",
    "        cs.zip,\n",
    "        cs.city,\n",
    "        cs.st,\n",
    "        MAX(cs.year_month) AS year_month,\n",
    "        cs.total_sales AS customer_total_sales,\n",
    "        m.NumMonths,\n",
    "        CASE\n",
    "            WHEN m.NumMonths > 0 THEN 1. * cs.total_sales / m.NumMonths\n",
    "            ELSE 0  \n",
    "        END AS avg_sales_prior\n",
    "    FROM\n",
    "        CustomerSales cs\n",
    "        CROSS JOIN Months m\n",
    "    GROUP BY\n",
    "        cs.cust_id, cs.name, cs.addr, cs.zip, cs.city, cs.st, m.NumMonths\n",
    ")\n",
    "\n",
    "SELECT\n",
    "    cust_id,\n",
    "    name,\n",
    "    addr,\n",
    "    zip,\n",
    "    city,\n",
    "    st,\n",
    "    year_month,\n",
    "    avg_sales_prior\n",
    "FROM\n",
    "    AverageSales\n",
    "ORDER BY\n",
    "    avg_sales_prior DESC;\n",
    "'''\n",
    "pd.read_sql(sql5,conn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "72f836cc-36af-45dd-8156-71cb8bbd29bb",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q5']['sql'] = sql5"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b9adfc13-2987-4453-9629-7cfb54a2664e",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6e22a1e4-f985-495d-9197-dd536069d7f9",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e9473732-c995-4e93-a0fc-834e53c8196d",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ab0649b8-478a-4ec3-a5d8-653f8986865d",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e3501b66-a6d5-4d23-a2cc-1206fe40cc34",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "01da1192-59d0-40ee-bf68-0094984a5329",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "25a952d1-6687-47e2-b3ea-e43051ab5630",
   "metadata": {},
   "source": [
    "---\n",
    "6) Are there any products we haven't sold at least 1 of each month?\n",
    "\n",
    "If so, return:\n",
    " \n",
    "- prod_id\n",
    "- prod_desc\n",
    "- unit_price\n",
    "- year_month\n",
    "\n",
    "Order the results by prod_id, year_month, both ascending"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5c23f39d-8a7d-4dcb-b953-95a3a24d5925",
   "metadata": {},
   "source": [
    "DONE"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "d30460af-c524-4836-b352-18b656271993",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "      <th>unit_price</th>\n",
       "      <th>year_month</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>300</td>\n",
       "      <td>Washer</td>\n",
       "      <td>0.10</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>301</td>\n",
       "      <td>Nail</td>\n",
       "      <td>0.25</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>305</td>\n",
       "      <td>Bradawl</td>\n",
       "      <td>1.99</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>307</td>\n",
       "      <td>Sandpaper</td>\n",
       "      <td>3.00</td>\n",
       "      <td>2019-03</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>308</td>\n",
       "      <td>Screwdriver</td>\n",
       "      <td>3.00</td>\n",
       "      <td>2019-05</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>309</td>\n",
       "      <td>Chisel</td>\n",
       "      <td>4.99</td>\n",
       "      <td>2019-07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>310</td>\n",
       "      <td>Scraper</td>\n",
       "      <td>7.99</td>\n",
       "      <td>2019-04</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>312</td>\n",
       "      <td>Plane</td>\n",
       "      <td>10.99</td>\n",
       "      <td>2019-07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>313</td>\n",
       "      <td>Wrench</td>\n",
       "      <td>11.00</td>\n",
       "      <td>2019-06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>314</td>\n",
       "      <td>Mallet</td>\n",
       "      <td>12.00</td>\n",
       "      <td>2019-06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>315</td>\n",
       "      <td>Pliers</td>\n",
       "      <td>15.99</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>318</td>\n",
       "      <td>Hacksaw</td>\n",
       "      <td>19.99</td>\n",
       "      <td>2019-04</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>321</td>\n",
       "      <td>Axe</td>\n",
       "      <td>27.99</td>\n",
       "      <td>2019-07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "      <td>50.00</td>\n",
       "      <td>2019-07</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "      <td>50.00</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>328</td>\n",
       "      <td>Workbench</td>\n",
       "      <td>300.00</td>\n",
       "      <td>2019-04</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>499.99</td>\n",
       "      <td>2019-08</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>499.99</td>\n",
       "      <td>2019-09</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    prod_id    prod_desc  unit_price year_month\n",
       "0       300       Washer        0.10    2019-09\n",
       "1       301         Nail        0.25    2019-09\n",
       "2       305      Bradawl        1.99    2019-09\n",
       "3       307    Sandpaper        3.00    2019-03\n",
       "4       308  Screwdriver        3.00    2019-05\n",
       "5       309       Chisel        4.99    2019-07\n",
       "6       310      Scraper        7.99    2019-04\n",
       "7       312        Plane       10.99    2019-07\n",
       "8       313       Wrench       11.00    2019-06\n",
       "9       314       Mallet       12.00    2019-06\n",
       "10      315       Pliers       15.99    2019-09\n",
       "11      318      Hacksaw       19.99    2019-04\n",
       "12      321          Axe       27.99    2019-07\n",
       "13      325      Toolbox       50.00    2019-07\n",
       "14      325      Toolbox       50.00    2019-09\n",
       "15      328    Workbench      300.00    2019-04\n",
       "16      329     Chainsaw      499.99    2019-08\n",
       "17      329     Chainsaw      499.99    2019-09"
      ]
     },
     "execution_count": 23,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql6 = '''\n",
    "WITH MonthlyProductSales AS (\n",
    "    SELECT\n",
    "        p.prod_id,\n",
    "        p.prod_name AS prod_desc,\n",
    "        p.unit_price,\n",
    "        strftime('%Y-%m', o.date) AS year_month\n",
    "    FROM\n",
    "        tProd p\n",
    "        CROSS JOIN (SELECT DISTINCT strftime('%Y-%m', date) AS year_month FROM tOrder) months\n",
    "        LEFT JOIN tOrderDetail od ON p.prod_id = od.prod_id\n",
    "        LEFT JOIN tOrder o ON od.order_id = o.order_id AND strftime('%Y-%m', o.date) = months.year_month\n",
    "    WHERE\n",
    "        o.order_id IS NOT NULL\n",
    ")\n",
    ", ProductsSoldInEachMonth AS (\n",
    "    SELECT\n",
    "        prod_id,\n",
    "        year_month\n",
    "    FROM\n",
    "        MonthlyProductSales\n",
    "    GROUP BY\n",
    "        prod_id, year_month\n",
    "    HAVING\n",
    "        COUNT(*) > 0\n",
    ")\n",
    ", AllProductsAndMonths AS (\n",
    "    SELECT\n",
    "        p.prod_id,\n",
    "        p.prod_name AS prod_desc,\n",
    "        p.unit_price,\n",
    "        months.year_month\n",
    "    FROM\n",
    "        tProd p\n",
    "        CROSS JOIN (SELECT DISTINCT strftime('%Y-%m', date) AS year_month FROM tOrder) months\n",
    ")\n",
    "SELECT\n",
    "    apm.prod_id,\n",
    "    apm.prod_desc,\n",
    "    apm.unit_price,\n",
    "    apm.year_month\n",
    "FROM\n",
    "    AllProductsAndMonths apm\n",
    "    LEFT JOIN ProductsSoldInEachMonth ps ON apm.prod_id = ps.prod_id AND apm.year_month = ps.year_month\n",
    "WHERE\n",
    "    ps.prod_id IS NULL\n",
    "ORDER BY\n",
    "    apm.prod_id ASC,\n",
    "    apm.year_month ASC;\n",
    "\n",
    "'''\n",
    "pd.read_sql(sql6, conn)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5c55542e-3396-45ef-b86d-e1ad8c785ed3",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "a81af7c6-c671-48e7-9044-ca1221a260d0",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q6']['sql'] = sql6"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a41e4a52-1d08-48b7-a9e0-154f03c5a892",
   "metadata": {},
   "source": [
    "---\n",
    "7) What are our top 5 selling products (in terms of total dollars sold)?\n",
    "\n",
    "Return:\n",
    "\n",
    "- prod_id\n",
    "- prod_desc\n",
    "- unit_price\n",
    "- total sales (i.e. sum of qty * unit price)\n",
    "\n",
    "Order the results by total sales, descending"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f088b1de-392e-48fe-8d8e-c1b78c5eb494",
   "metadata": {},
   "source": [
    "DONE"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "2e3c5da0-c69f-4c80-8d67-23ed2c0c6cbb",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "      <th>unit_price</th>\n",
       "      <th>total_sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>499.99</td>\n",
       "      <td>943481.13</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>328</td>\n",
       "      <td>Workbench</td>\n",
       "      <td>300.00</td>\n",
       "      <td>633300.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>327</td>\n",
       "      <td>Ladder</td>\n",
       "      <td>80.00</td>\n",
       "      <td>154000.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>326</td>\n",
       "      <td>Drill</td>\n",
       "      <td>69.00</td>\n",
       "      <td>131652.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "      <td>50.00</td>\n",
       "      <td>100850.00</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   prod_id  prod_desc  unit_price  total_sales\n",
       "0      329   Chainsaw      499.99    943481.13\n",
       "1      328  Workbench      300.00    633300.00\n",
       "2      327     Ladder       80.00    154000.00\n",
       "3      326      Drill       69.00    131652.00\n",
       "4      325    Toolbox       50.00    100850.00"
      ]
     },
     "execution_count": 25,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql7 = '''\n",
    "SELECT prod_id,prod_name AS prod_desc,unit_price,SUM(qty * unit_price) AS total_sales\n",
    "FROM tProd JOIN tOrderDetail USING (prod_id)\n",
    "GROUP BY prod_id,prod_name,unit_price\n",
    "ORDER BY total_sales DESC\n",
    "LIMIT 5;\n",
    "'''\n",
    "pd.read_sql(sql7, conn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "85620d76-368c-46ee-809d-fc72527c3200",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q7']['sql'] = sql7"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b78bd07a-4fd2-497f-9128-7b412af46c5e",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "8) What month did we have our highest sales, and what was our top selling product that month? (All in terms of dollars).\n",
    "\n",
    "Return:\n",
    "\n",
    "- year_month\n",
    "- prod_id\n",
    "- prod_desc\n",
    "- The total sales for that month, for all products\n",
    "- The total sales for that month, for the top selling product only\n",
    "- The total quantity for that month, for the top selling product only"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "3a7f8626-1d1c-43ae-a54e-f1621b18eb32",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year_month</th>\n",
       "      <th>total_sales_for_all_products</th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "      <th>total_sales_for_top_product</th>\n",
       "      <th>total_quantity_for_top_product</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2021-10</td>\n",
       "      <td>251768.12</td>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>86998.26</td>\n",
       "      <td>174</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  year_month  total_sales_for_all_products  prod_id prod_desc  \\\n",
       "0    2021-10                     251768.12      329  Chainsaw   \n",
       "\n",
       "   total_sales_for_top_product  total_quantity_for_top_product  \n",
       "0                     86998.26                             174  "
      ]
     },
     "execution_count": 27,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sql8 = '''\n",
    "WITH MonthlyTotalSales AS (\n",
    "    SELECT\n",
    "        strftime('%Y-%m', o.date) AS year_month,\n",
    "        SUM(od.qty * p.unit_price) AS total_sales_for_all_products\n",
    "    FROM\n",
    "        tOrder o\n",
    "        JOIN tOrderDetail od ON o.order_id = od.order_id\n",
    "        JOIN tProd p ON od.prod_id = p.prod_id\n",
    "    GROUP BY\n",
    "        year_month\n",
    "),\n",
    "MonthlyProductSales AS (\n",
    "    SELECT\n",
    "        strftime('%Y-%m', o.date) AS year_month,\n",
    "        p.prod_id,\n",
    "        p.prod_name AS prod_desc,\n",
    "        SUM(od.qty * p.unit_price) AS total_sales_for_product,\n",
    "        SUM(od.qty) AS total_quantity_for_product\n",
    "    FROM\n",
    "        tOrder o\n",
    "        JOIN tOrderDetail od ON o.order_id = od.order_id\n",
    "        JOIN tProd p ON od.prod_id = p.prod_id\n",
    "    GROUP BY\n",
    "        year_month,\n",
    "        p.prod_id,\n",
    "        p.prod_name\n",
    "),\n",
    "TopSellingProductPerMonth AS (\n",
    "    SELECT\n",
    "        year_month,\n",
    "        prod_id,\n",
    "        prod_desc,\n",
    "        total_sales_for_product,\n",
    "        total_quantity_for_product,\n",
    "        RANK() OVER (PARTITION BY year_month ORDER BY total_sales_for_product DESC) AS sales_rank\n",
    "    FROM\n",
    "        MonthlyProductSales\n",
    ")\n",
    "SELECT\n",
    "    mts.year_month,\n",
    "    mts.total_sales_for_all_products,\n",
    "    ts.prod_id,\n",
    "    ts.prod_desc,\n",
    "    MAX(ts.total_sales_for_product) AS total_sales_for_top_product,\n",
    "    MAX(ts.total_quantity_for_product) AS total_quantity_for_top_product\n",
    "FROM\n",
    "    MonthlyTotalSales mts\n",
    "    JOIN TopSellingProductPerMonth ts ON mts.year_month = ts.year_month\n",
    "WHERE\n",
    "    ts.sales_rank = 1\n",
    "GROUP BY\n",
    "    mts.year_month, ts.prod_id, ts.prod_desc\n",
    "ORDER BY total_quantity_for_top_product DESC\n",
    "LIMIT 1;\n",
    "'''\n",
    "pd.read_sql(sql8,conn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "77c557fd-d2ba-4821-8831-75e1460ba54c",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "129bcc1e-6cd2-4c2c-9cb9-6aa3d52ac395",
   "metadata": {},
   "outputs": [],
   "source": [
    "my_sql['q8']['sql'] = sql8"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "b644be04-fe38-471b-afa4-6195898fde93",
   "metadata": {},
   "outputs": [],
   "source": [
    "conn.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "9acbd679-1ca5-42e2-baa4-ab1fe3e4cf42",
   "metadata": {},
   "outputs": [],
   "source": [
    "with open('final.data302', 'w') as f:\n",
    "    json.dump(my_sql, f)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "a06f9fa6-d967-4f4c-94ee-adaeb4bfa626",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Report saved to:  VALIDATION_final.txt\n"
     ]
    }
   ],
   "source": [
    "dbga.validate_submission_format(path_db = '/home/jovyan/Databases/04_Building/store.db',\n",
    "                                path_submission = 'final.data302',\n",
    "                                num_questions = 8)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "074a22ae-11a8-4f4c-bd8d-86bde69f5f48",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "key:  setup\n",
      "value:  ['DROP VIEW IF EXISTS StateSalesView;', \"\\nCREATE VIEW StateSalesView AS\\nWITH StateSales AS (\\n    SELECT tZip.state_id,\\n        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales\\n    FROM tZip\\n        JOIN tCust USING (zip)\\n        JOIN tOrder USING (cust_id)\\n        JOIN tOrderDetail USING (order_id)\\n        JOIN tProd USING (prod_id)\\n    WHERE strftime('%Y-%m', tOrder.date) = '2019-09'\\n    GROUP BY tZip.state_id\\n)\\nSELECT s.state_id,\\n    IFNULL(ss.total_sales, 0) AS total_sales\\nFROM (\\n    SELECT DISTINCT state_id FROM tZip\\n) s\\nLEFT JOIN StateSales ss USING (state_id)\\nORDER BY s.state_id;\\n\"]\n",
      "\n",
      "\n",
      "key:  q1\n",
      "value:  {'sql': \"\\nWITH TotalsPerMonth AS (\\n    SELECT\\n        strftime('%Y-%m', date) AS year_month,\\n        sum(qty * unit_price) AS TotalSales,\\n        count(DISTINCT order_id) AS NumOrders,\\n        count(DISTINCT cust_id) AS NumCust\\n    FROM tOrder\\n    JOIN tOrderDetail USING(order_id)\\n    JOIN tProd USING(prod_id)\\n    GROUP BY year_month\\n)\\nSELECT\\n    year_month,\\n    sum(TotalSales) AS Sales,\\n    sum(NumOrders) AS NumOrders,\\n    sum(NumCust) AS NumCust,\\n    AVG(NumOrders * 1.0 / NumCust) AS OrdersPerCust,\\n    AVG(TotalSales * 1.0 / NumCust) AS SalesPerCust,\\n    AVG(TotalSales * 1.0 / NumOrders) AS SalesPerOrder\\nFROM TotalsPerMonth\\nGROUP BY year_month\\nORDER BY year_month ASC;\\n\"}\n",
      "\n",
      "\n",
      "key:  q2\n",
      "value:  {'sql': \"\\nSELECT\\n    strftime('%Y-%m', date) AS year_month,\\n    SUM(tOrderDetail.qty * tProd.unit_price) AS sales\\nFROM\\n    tOrder\\n    JOIN tOrderDetail USING (order_id)\\n    JOIN tProd USING (prod_id)\\n    JOIN tCust USING (cust_id)\\nGROUP BY year_month\\nORDER BY sales ASC\\nLIMIT 1\\n;\"}\n",
      "\n",
      "\n",
      "key:  q3\n",
      "value:  {'sql': '\\nSELECT\\n    s.state_id,\\n    IFNULL(ss.total_sales, 0) AS total_sales\\nFROM (\\n    SELECT DISTINCT state_id FROM tZip\\n) s\\nLEFT JOIN StateSalesView ss USING (state_id)\\nORDER BY s.state_id;\\n'}\n",
      "\n",
      "\n",
      "key:  q4\n",
      "value:  {'sql': \"\\nWITH CustomerSales AS (\\n    SELECT\\n        tCust.cust_id,\\n        tCust.first,\\n        tCust.last,\\n        tCust.addr,\\n        tZip.city,\\n        tZip.state_id AS st,\\n        tCust.zip,\\n        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales\\n    FROM\\n        tCust\\n        JOIN tZip USING (zip)\\n        LEFT JOIN tOrder USING (cust_id)\\n        LEFT JOIN tOrderDetail USING (order_id)\\n        LEFT JOIN tProd USING (prod_id)\\n    WHERE\\n        strftime('%Y-%m', IFNULL(tOrder.date, '2019-09')) >= '2019-09'\\n    GROUP BY\\n        tCust.cust_id\\n)\\nSELECT\\n    cs.cust_id,\\n    cs.first,\\n    cs.last,\\n    cs.addr,\\n    cs.city,\\n    cs.st,\\n    cs.zip,\\n    cs.total_sales AS customer_total_sales\\nFROM\\n    CustomerSales cs\\n    JOIN StateSalesView ssv ON cs.st = ssv.state_id\\nWHERE\\n    ssv.total_sales = 0\\nORDER BY\\n    cs.cust_id ASC;\\n\\n    \"}\n",
      "\n",
      "\n",
      "key:  q5\n",
      "value:  {'sql': \"\\nWITH LatestMonth AS (\\n    SELECT MAX(strftime('%Y-%m', date)) AS latest_month\\n    FROM tOrder\\n),\\nCustomersWithoutPurchase AS (\\n    SELECT DISTINCT tCust.cust_id\\n    FROM tCust\\n    WHERE tCust.cust_id NOT IN (\\n        SELECT DISTINCT cust_id\\n        FROM tOrder\\n        WHERE strftime('%Y-%m', date) = (SELECT latest_month FROM LatestMonth)\\n    )\\n),\\nMonths AS (\\n    SELECT COUNT(DISTINCT strftime('%Y-%m', date)) - 1 AS NumMonths\\n    FROM tOrder\\n),\\nCustomerSales AS (\\n    SELECT\\n        tCust.cust_id,\\n        tCust.first || ' ' || tCust.last AS name,\\n        tCust.addr,\\n        tZip.zip,\\n        tZip.city,\\n        tZip.state_id AS st,\\n        IFNULL(SUM(tOrderDetail.qty * tProd.unit_price), 0) AS total_sales,\\n        strftime('%Y-%m', IFNULL(tOrder.date, '0000-00-00')) AS year_month\\n    FROM\\n        tCust\\n        JOIN tZip USING (zip)\\n        LEFT JOIN tOrder USING (cust_id)\\n        LEFT JOIN tOrderDetail USING (order_id)\\n        LEFT JOIN tProd USING (prod_id)\\n    WHERE\\n        tCust.cust_id IN (SELECT cust_id FROM CustomersWithoutPurchase)\\n        AND (strftime('%Y-%m', IFNULL(tOrder.date, '0000-00-00')) < (SELECT latest_month FROM LatestMonth))\\n    GROUP BY\\n        tCust.cust_id, year_month\\n),\\nAverageSales AS (\\n    SELECT\\n        cs.cust_id,\\n        cs.name,\\n        cs.addr,\\n        cs.zip,\\n        cs.city,\\n        cs.st,\\n        MAX(cs.year_month) AS year_month,\\n        cs.total_sales AS customer_total_sales,\\n        m.NumMonths,\\n        CASE\\n            WHEN m.NumMonths > 0 THEN 1. * cs.total_sales / m.NumMonths\\n            ELSE 0  \\n        END AS avg_sales_prior\\n    FROM\\n        CustomerSales cs\\n        CROSS JOIN Months m\\n    GROUP BY\\n        cs.cust_id, cs.name, cs.addr, cs.zip, cs.city, cs.st, m.NumMonths\\n)\\n\\nSELECT\\n    cust_id,\\n    name,\\n    addr,\\n    zip,\\n    city,\\n    st,\\n    year_month,\\n    avg_sales_prior\\nFROM\\n    AverageSales\\nORDER BY\\n    avg_sales_prior DESC;\\n\"}\n",
      "\n",
      "\n",
      "key:  q6\n",
      "value:  {'sql': \"\\nWITH MonthlyProductSales AS (\\n    SELECT\\n        p.prod_id,\\n        p.prod_name AS prod_desc,\\n        p.unit_price,\\n        strftime('%Y-%m', o.date) AS year_month\\n    FROM\\n        tProd p\\n        CROSS JOIN (SELECT DISTINCT strftime('%Y-%m', date) AS year_month FROM tOrder) months\\n        LEFT JOIN tOrderDetail od ON p.prod_id = od.prod_id\\n        LEFT JOIN tOrder o ON od.order_id = o.order_id AND strftime('%Y-%m', o.date) = months.year_month\\n    WHERE\\n        o.order_id IS NOT NULL\\n)\\n, ProductsSoldInEachMonth AS (\\n    SELECT\\n        prod_id,\\n        year_month\\n    FROM\\n        MonthlyProductSales\\n    GROUP BY\\n        prod_id, year_month\\n    HAVING\\n        COUNT(*) > 0\\n)\\n, AllProductsAndMonths AS (\\n    SELECT\\n        p.prod_id,\\n        p.prod_name AS prod_desc,\\n        p.unit_price,\\n        months.year_month\\n    FROM\\n        tProd p\\n        CROSS JOIN (SELECT DISTINCT strftime('%Y-%m', date) AS year_month FROM tOrder) months\\n)\\nSELECT\\n    apm.prod_id,\\n    apm.prod_desc,\\n    apm.unit_price,\\n    apm.year_month\\nFROM\\n    AllProductsAndMonths apm\\n    LEFT JOIN ProductsSoldInEachMonth ps ON apm.prod_id = ps.prod_id AND apm.year_month = ps.year_month\\nWHERE\\n    ps.prod_id IS NULL\\nORDER BY\\n    apm.prod_id ASC,\\n    apm.year_month ASC;\\n\\n\"}\n",
      "\n",
      "\n",
      "key:  q7\n",
      "value:  {'sql': '\\nSELECT prod_id,prod_name AS prod_desc,unit_price,SUM(qty * unit_price) AS total_sales\\nFROM tProd JOIN tOrderDetail USING (prod_id)\\nGROUP BY prod_id,prod_name,unit_price\\nORDER BY total_sales DESC\\nLIMIT 5;\\n'}\n",
      "\n",
      "\n",
      "key:  q8\n",
      "value:  {'sql': \"\\nWITH MonthlyTotalSales AS (\\n    SELECT\\n        strftime('%Y-%m', o.date) AS year_month,\\n        SUM(od.qty * p.unit_price) AS total_sales_for_all_products\\n    FROM\\n        tOrder o\\n        JOIN tOrderDetail od ON o.order_id = od.order_id\\n        JOIN tProd p ON od.prod_id = p.prod_id\\n    GROUP BY\\n        year_month\\n),\\nMonthlyProductSales AS (\\n    SELECT\\n        strftime('%Y-%m', o.date) AS year_month,\\n        p.prod_id,\\n        p.prod_name AS prod_desc,\\n        SUM(od.qty * p.unit_price) AS total_sales_for_product,\\n        SUM(od.qty) AS total_quantity_for_product\\n    FROM\\n        tOrder o\\n        JOIN tOrderDetail od ON o.order_id = od.order_id\\n        JOIN tProd p ON od.prod_id = p.prod_id\\n    GROUP BY\\n        year_month,\\n        p.prod_id,\\n        p.prod_name\\n),\\nTopSellingProductPerMonth AS (\\n    SELECT\\n        year_month,\\n        prod_id,\\n        prod_desc,\\n        total_sales_for_product,\\n        total_quantity_for_product,\\n        RANK() OVER (PARTITION BY year_month ORDER BY total_sales_for_product DESC) AS sales_rank\\n    FROM\\n        MonthlyProductSales\\n)\\nSELECT\\n    mts.year_month,\\n    mts.total_sales_for_all_products,\\n    ts.prod_id,\\n    ts.prod_desc,\\n    MAX(ts.total_sales_for_product) AS total_sales_for_top_product,\\n    MAX(ts.total_quantity_for_product) AS total_quantity_for_top_product\\nFROM\\n    MonthlyTotalSales mts\\n    JOIN TopSellingProductPerMonth ts ON mts.year_month = ts.year_month\\nWHERE\\n    ts.sales_rank = 1\\nGROUP BY\\n    mts.year_month, ts.prod_id, ts.prod_desc\\nORDER BY total_quantity_for_top_product DESC\\nLIMIT 1;\\n\"}\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "for key, value in my_sql.items():\n",
    "    print('key: ', key)\n",
    "    print('value: ', value)\n",
    "    print('\\n')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6290e354-920d-4299-900a-29867177beb2",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
